<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü™¶ Code Graveyard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-color: #f0f4f8;
      --border-color: #000;
      --shadow-color: #000;
      --shadow-offset: 6px;
      --bubble-bg: #fff;
      --bubble-hover-bg: #fffeca;
      --accent-red: #ff6b81;
      --accent-green: #2ed573;
      --accent-yellow: #ffa502;
      --accent-purple: #a55eea;
    }
    
    body {
      font-family: "Comic Sans MS", "Comic Sans", cursive, sans-serif;
      background: var(--bg-color);
      min-height: 100vh;
      padding: 30px;
      width: 340px;
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255, 107, 129, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(165, 94, 234, 0.1) 0%, transparent 50%);
    }
    
    /* Ê∞îÊ≥°Âü∫Á°ÄÊ†∑Âºè */
    .bubble {
      background: var(--bubble-bg);
      border: 3px solid var(--border-color);
      border-radius: 30px;
      padding: 20px 25px;
      box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .bubble:hover {
      transform: scale(0.97) translate(3px, 3px);
      box-shadow: 0 0 0 var(--shadow-color);
      background: var(--bubble-hover-bg);
    }
    
    .bubble:active {
      transform: scale(0.95) translate(6px, 6px);
      box-shadow: none;
    }
    
    /* Ê†áÈ¢òÊ∞îÊ≥° */
    .header-bubble {
      background: var(--accent-red);
      color: white;
      text-align: center;
      margin-bottom: 25px;
    }
    
    .header-bubble h1 {
      font-size: 1.6rem;
      font-weight: 900;
      margin: 0;
      text-shadow: 2px 2px 0 var(--shadow-color);
      letter-spacing: 1px;
    }
    
    .header-bubble p {
      font-size: 0.85rem;
      margin: 5px 0 0 0;
      opacity: 0.9;
    }
    
    /* ÁªüËÆ°ÁΩëÊ†º */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin-bottom: 20px;
    }
    
    .stat-bubble {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-bubble .icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .stat-bubble .label {
      font-size: 0.75rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-bubble .value {
      font-size: 1.8rem;
      font-weight: 900;
      color: #1a1a2e;
    }
    
    /* ËØàÂ∞∏Ê∞îÊ≥° */
    .zombie-bubble {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
    }
    
    .zombie-text {
      font-size: 1.3rem;
      font-weight: 900;
      text-shadow: 2px 2px 0 var(--shadow-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .zombie-emoji {
      font-size: 2.5rem;
      animation: zombieBounce 1s ease-in-out infinite;
    }
    
    @keyframes zombieBounce {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-5px) rotate(5deg); }
    }
    
    .lightning {
      font-size: 2.2rem;
      transform: rotate(15deg);
      filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3));
    }
    
    /* Êâ´ÊèèÊ†áÁ≠æ */
    .scan-tag {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .scan-info {
      background: var(--accent-green);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      border: 2px solid var(--border-color);
      box-shadow: 3px 3px 0 var(--shadow-color);
      transform: rotate(-1deg);
    }
    
    .scan-info:hover {
      transform: rotate(1deg) scale(0.98);
    }
    
    /* Êâ´ÊèèËøõÂ∫¶ */
    .scan-progress {
      display: none;
      margin-bottom: 20px;
    }
    
    .scan-progress.active {
      display: block;
    }
    
    .scan-progress .bubble {
      padding: 15px 20px;
    }
    
    .scan-progress .label {
      font-size: 0.85rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }
    
    .progress-bar {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      border: 2px solid var(--border-color);
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-red));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    /* ÊåâÈíÆÊ∞îÊ≥° */
    .btn-bubble {
      background: var(--accent-purple);
      color: white;
      border: none;
      font-family: inherit;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      margin-bottom: 12px;
    }
    
    .btn-bubble:hover {
      transform: scale(0.98) translate(3px, 3px);
      box-shadow: 0 0 0 var(--shadow-color);
      background: #9458d0;
    }
    
    .btn-bubble:active {
      transform: scale(0.95) translate(6px, 6px);
      box-shadow: none;
    }
    
    .btn-bubble:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color) !important;
    }
    
    .btn-bubble.secondary {
      background: var(--accent-yellow);
      color: #1a1a2e;
    }
    
    .btn-bubble.secondary:hover {
      background: #ffb142;
    }
    
    .btn-bubble.green {
      background: var(--accent-green);
    }
    
    .btn-bubble.green:hover {
      background: #26de81;
    }
    
    /* Â¢ìÁ¢ëÂàóË°® */
    .corpses-section {
      margin-top: 10px;
    }
    
    .section-title {
      font-size: 1rem;
      font-weight: 900;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .corpses-list {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .corpses-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .corpses-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }
    
    .corpse-bubble {
      background: var(--bubble-bg);
      border: 2px solid var(--border-color);
      border-radius: 15px;
      padding: 12px 15px;
      margin-bottom: 10px;
      box-shadow: 4px 4px 0 var(--shadow-color);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    
    .corpse-bubble:hover {
      transform: scale(0.98) translate(2px, 2px);
      box-shadow: 0 0 0 var(--shadow-color);
      background: var(--bubble-hover-bg);
    }
    
    .corpse-bubble:last-child {
      margin-bottom: 0;
    }
    
    .corpse-name {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .corpse-meta {
      font-size: 0.75rem;
      color: #666;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .corpse-meta span {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .corpse-tags {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .tag {
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 700;
      border: 2px solid var(--border-color);
    }
    
    .tag.zombie {
      background: var(--accent-red);
      color: white;
    }
    
    .tag.lang {
      background: #e0e0e0;
    }
    
    /* Á©∫Áä∂ÊÄÅ */
    .empty-bubble {
      background: var(--bubble-bg);
      border: 2px dashed var(--border-color);
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      color: #888;
    }
    
    .empty-bubble .icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    /* Â∫ïÈÉ® */
    .footer {
      text-align: center;
      margin-top: 15px;
      font-size: 0.7rem;
      color: #888;
      font-weight: 700;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #1a1a2e;
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 700;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      border: 2px solid var(--border-color);
      box-shadow: 4px 4px 0 var(--shadow-color);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      background: var(--accent-green);
    }
    
    .toast.error {
      background: var(--accent-red);
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(240, 248, 255, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      text-align: center;
    }
    
    .loading-spinner {
      font-size: 3rem;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      margin-top: 15px;
      font-weight: 700;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <!-- Ê†áÈ¢ò -->
  <div class="bubble header-bubble" onclick="visitRandom()">
    <h1>üëª CODE GRAVEYARD</h1>
    <p>Watch out for the zombies!</p>
  </div>
  
  <!-- ÁªüËÆ° -->
  <div class="stats-grid">
    <div class="bubble stat-bubble">
      <span class="icon">ü™¶</span>
      <div class="label">Total Tombs</div>
      <div class="value" id="total-corpses">--</div>
    </div>
    <div class="bubble stat-bubble">
      <span class="icon">üì¶</span>
      <div class="label">Survivors</div>
      <div class="value" id="survivors">--</div>
    </div>
  </div>
  
  <!-- ËØàÂ∞∏ÁªüËÆ° -->
  <div class="bubble zombie-bubble" onclick="showZombies()">
    <div class="zombie-text">
      <span>üßü</span>
      <span id="resurrected">0</span>
      <span>RESURRECTED!</span>
    </div>
    <div class="lightning">‚ö°</div>
  </div>
  
  <!-- Êâ´ÊèèÁä∂ÊÄÅ -->
  <div class="scan-tag">
    <div class="scan-info" id="scan-info">
      üìä SCANNED: <span id="last-scan">NEVER</span>
    </div>
  </div>
  
  <!-- Êâ´ÊèèËøõÂ∫¶ -->
  <div class="scan-progress" id="scan-progress">
    <div class="bubble">
      <div class="label">
        <span>üîÑ SCANNING...</span>
        <span id="scan-percent">0%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
    </div>
  </div>
  
  <!-- Êìç‰ΩúÊåâÈíÆ -->
  <div class="bubble btn-bubble" id="scan-btn" onclick="scanCemetery()">
    üîç SCAN NOW
  </div>
  
  <div class="bubble btn-bubble secondary" onclick="openSettings()">
    ‚öôÔ∏è SETTINGS
  </div>
  
  <div class="bubble btn-bubble green" onclick="sendReport()">
    üì§ SEND REPORT
  </div>
  
  <!-- Â¢ìÁ¢ëÂàóË°® -->
  <div class="corpses-section">
    <div class="section-title">üìú LATEST TOMBS</div>
    <div class="corpses-list" id="corpses-list">
      <div class="empty-bubble">
        <div class="icon">ü™¶</div>
        <p>No tombs yet...<br>Start scanning!</p>
      </div>
    </div>
  </div>
  
  <!-- Â∫ïÈÉ® -->
  <div class="footer">
    ü™¶ CODE GRAVEYARD v<span id="version">1.0</span>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="loading-content">
      <div class="loading-spinner">ü™¶</div>
      <div class="loading-text" id="loading-text">Scanning...</div>
    </div>
  </div>

  <script>
    const invoke = window.__TAURI__.core.invoke;
    let isScanning = false;
    
    // ÊòæÁ§∫ Toast
    function showToast(message, type = 'default') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // ÊòæÁ§∫/ÈöêËóè Loading
    function setLoading(show, text = 'Scanning...') {
      const loading = document.getElementById('loading');
      document.getElementById('loading-text').textContent = text;
      if (show) loading.classList.add('active');
      else loading.classList.remove('active');
    }
    
    // Ê†ºÂºèÂåñÊó∂Èó¥
    function formatTimeAgo(dateStr) {
      if (!dateStr || dateStr === 'Êú™Áü•' || dateStr === 'Never' || dateStr === 'NEVER') return 'NEVER';
      
      try {
        const date = new Date(dateStr);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'JUST NOW';
        if (diff < 3600) return Math.floor(diff / 60) + ' MINS AGO';
        if (diff < 86400) return Math.floor(diff / 3600) + ' HOURS AGO';
        return Math.floor(diff / 86400) + ' DAYS AGO';
      } catch (e) {
        return dateStr;
      }
    }
    
    // Âä†ËΩΩÁªüËÆ°
    async function loadStats() {
      try {
        const stats = await invoke('get_stats');
        document.getElementById('total-corpses').textContent = formatNumber(stats.total_tombstones || 0);
        document.getElementById('survivors').textContent = formatNumber(stats.total_assets || 0);
        document.getElementById('resurrected').textContent = formatNumber(stats.resurrected || 0);
        document.getElementById('last-scan').textContent = formatTimeAgo(stats.last_scan);
      } catch (e) {
        console.log('Ëé∑ÂèñÁªüËÆ°Â§±Ë¥•:', e);
        // ÈªòËÆ§Êï∞ÊçÆ
        document.getElementById('total-corpses').textContent = '0';
        document.getElementById('survivors').textContent = '0';
        document.getElementById('resurrected').textContent = '0';
        document.getElementById('last-scan').textContent = 'NEVER';
      }
    }
    
    // Âä†ËΩΩÁâàÊú¨
    async function loadVersion() {
      try {
        const version = await invoke('get_version');
        document.getElementById('version').textContent = version || '1.0';
      } catch (e) {
        document.getElementById('version').textContent = '1.0';
      }
    }
    
    // Âä†ËΩΩÂ¢ìÁ¢ëÂàóË°®
    async function loadCorpses() {
      try {
        const corpses = await invoke('get_recent_corpses', { limit: 10 });
        const list = document.getElementById('corpses-list');
        
        if (!corpses || corpses.length === 0) {
          list.innerHTML = `
            <div class="empty-bubble">
              <div class="icon">ü™¶</div>
              <p>No tombs yet...<br>Start scanning!</p>
            </div>
          `;
          return;
        }
        
        list.innerHTML = corpses.map(c => `
          <div class="corpse-bubble" onclick="openPath('${c.original_path}')">
            <div class="corpse-name">
              ${c.language ? `<span style="color:${getLangColor(c.language)}">‚óè</span>` : ''}
              ${c.name || 'Unknown'}
            </div>
            <div class="corpse-meta">
              <span>üíÄ ${c.cause_of_death || c.cause || 'Unknown'}</span>
              <span>üìÖ ${c.died_at ? c.died_at.split('T')[0] : 'Unknown'}</span>
            </div>
            <div class="corpse-tags">
              ${c.resurrected_at ? '<span class="tag zombie">üßü ZOMBIE</span>' : ''}
              ${c.language ? `<span class="tag lang">${c.language}</span>` : ''}
              ${c.tags ? c.tags.slice(0, 3).map(t => `<span class="tag lang">${t}</span>`).join('') : ''}
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.log('Ëé∑ÂèñÂ¢ìÁ¢ëÂ§±Ë¥•:', e);
        document.getElementById('corpses-list').innerHTML = `
          <div class="empty-bubble">
            <div class="icon">ü™¶</div>
            <p>No tombs yet...<br>Start scanning!</p>
          </div>
        `;
      }
    }
    
    // Ê†ºÂºèÂåñÊï∞Â≠ó
    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toString();
    }
    
    // ËØ≠Ë®ÄÈ¢úËâ≤
    function getLangColor(lang) {
      const colors = {
        'Rust': '#dea584',
        'JavaScript': '#f1e05a',
        'TypeScript': '#2b7489',
        'Python': '#3572A5',
        'Go': '#00ADD8',
        'Java': '#b07219',
        'C++': '#f34b7d',
        'C': '#555555',
        'Vue': '#41b883',
        'HTML': '#e34c26',
        'CSS': '#563d7c',
      };
      return colors[lang] || '#888888';
    }
    
    // ÊâìÂºÄÊñá‰ª∂Ë∑ØÂæÑ
    async function openPath(path) {
      if (path && path !== 'unknown') {
        try {
          await invoke('shell_open', { path: path });
        } catch (e) {
          console.log('ÊâìÂºÄË∑ØÂæÑÂ§±Ë¥•:', e);
        }
      }
    }
    
    // ÈöèÊú∫ËÆøÈóÆÂ¢ìÁ¢ë
    async function visitRandom() {
      try {
        const result = await invoke('visit_random');
        if (result && result.name) {
          showToast(`ü™¶ ${result.name}`, 'success');
        }
      } catch (e) {
        showToast('ü™¶ No tombs to visit', 'error');
      }
    }
    
    // ÊòæÁ§∫ËØàÂ∞∏ÂàóË°®
    async function showZombies() {
      try {
        const corpses = await invoke('get_recent_corpses', { limit: 20 });
        const zombies = corpses.filter(c => c.resurrected_at);
        if (zombies.length > 0) {
          showToast(`üßü ${zombies.length} zombies found!`, 'success');
        } else {
          showToast('üßü No zombies yet', 'default');
        }
      } catch (e) {
        showToast('üßü No zombies', 'default');
      }
    }
    
    // Êâ´ÊèèÂ¢ìÂú∞
    async function scanCemetery() {
      if (isScanning) return;
      
      isScanning = true;
      const btn = document.getElementById('scan-btn');
      const progress = document.getElementById('scan-progress');
      const progressFill = document.getElementById('progress-fill');
      const progressPercent = document.getElementById('scan-percent');
      
      btn.disabled = true;
      btn.style.opacity = '0.6';
      progress.classList.add('active');
      
      try {
        const result = await invoke('trigger_scan');
        
        // Ê®°ÊãüËøõÂ∫¶
        for (let i = 0; i <= 100; i += 15) {
          progressFill.style.width = i + '%';
          progressPercent.textContent = i + '%';
          await new Promise(r => setTimeout(r, 80));
        }
        
        if (result.success) {
          showToast(`‚úÖ ${result.message || 'Scan complete!'}`, 'success');
          await loadStats();
          await loadCorpses();
        } else {
          showToast('‚ùå Scan failed!', 'error');
        }
      } catch (e) {
        console.log('Êâ´ÊèèÂ§±Ë¥•:', e);
        showToast('‚ùå Scan failed: ' + (e.message || e), 'error');
      } finally {
        isScanning = false;
        btn.disabled = false;
        btn.style.opacity = '1';
        setTimeout(() => {
          progress.classList.remove('active');
          progressFill.style.width = '0%';
        }, 500);
      }
    }
    
    // ÊâìÂºÄËÆæÁΩÆ
    async function openSettings() {
      setLoading(true, 'Loading config...');
      try {
        const config = await invoke('load_config');
        
        const token = prompt(
          'GitHub Token Setup\n\n' +
          'Enter your GitHub Personal Access Token:\n' +
          '- Needs repo and read:org permissions\n' +
          '- Increases API rate limit\n\n' +
          'Current Token: ' + (config.github_token ? 'Set ‚úì' : 'Not set')
        );
        
        if (token !== null) {
          await invoke('update_github_token', { token: token.trim() });
          showToast('‚úÖ Token updated!', 'success');
        }
      } catch (e) {
        console.log('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', e);
        showToast('‚ùå Config error', 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // ÂèëÈÄÅÊä•Âëä
    async function sendReport() {
      setLoading(true, 'Generating report...');
      try {
        const result = await invoke('send_report');
        showToast('üì§ ' + result, 'success');
      } catch (e) {
        console.log('ÂèëÈÄÅÂ§±Ë¥•:', e);
        showToast('‚ùå Send failed', 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // ÂàùÂßãÂåñ
    async function init() {
      await loadVersion();
      await loadStats();
      await loadCorpses();
    }
    
    init();
    
    // ÂÆöÊó∂Âà∑Êñ∞ (ÊØè5ÂàÜÈíü)
    setInterval(() => {
      if (!isScanning) {
        loadStats();
        loadCorpses();
      }
    }, 300000);
  </script>
</body>
</html>
