<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸª¦ Code Corpses</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      --bg-card: rgba(255,255,255,0.08);
      --bg-card-hover: rgba(255,255,255,0.12);
      --text-primary: #ffffff;
      --text-secondary: #8892b0;
      --text-muted: #6c757d;
      --accent-purple: #6c5ce7;
      --accent-blue: #0984e3;
      --accent-red: #d63031;
      --accent-green: #00b894;
      --accent-orange: #e17055;
      --accent-yellow: #fdcb6e;
      --border-radius: 12px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      width: 360px;
      overflow-x: hidden;
    }
    
    .header {
      text-align: center;
      margin-bottom: 20px;
      position: relative;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .header p {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .version-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent-purple);
      color: white;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .stat-card:hover {
      background: var(--bg-card-hover);
      transform: translateY(-2px);
    }
    
    .stat-card .icon { 
      font-size: 32px; 
      margin-bottom: 8px;
      display: block;
    }
    
    .stat-card .value { 
      font-size: 28px; 
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #a0a0a0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-card .label { 
      font-size: 11px; 
      color: var(--text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-card.zombie .value {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      -webkit-background-clip: text;
      background-clip: text;
    }
    
    .stat-card.scan .value {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      -webkit-background-clip: text;
      background-clip: text;
    }
    
    /* æ“ä½œæŒ‰é’® */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn.primary {
      background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
    }
    
    .btn.secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .btn.success {
      background: linear-gradient(135deg, var(--accent-green) 0%, #55efc4 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .btn-icon {
      font-size: 18px;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      border-radius: inherit;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent-purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      position: absolute;
      bottom: 20%;
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    /* æ‰«æè¿›åº¦æ¡ */
    .scan-progress {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      display: none;
    }
    
    .scan-progress.active {
      display: block;
    }
    
    .scan-progress .label {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }
    
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
      width: 0%;
      transition: width 0.3s ease;
      animation: progressPulse 2s ease-in-out infinite;
    }
    
    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* åˆ†åŒºæ ‡é¢˜ */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .section-title {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .refresh-btn {
      background: none;
      border: none;
      color: var(--accent-purple);
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .refresh-btn:hover {
      background: rgba(108, 92, 231, 0.2);
    }
    
    /* å¢“ç¢‘åˆ—è¡¨ */
    .corpses-list {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 12px;
      max-height: 280px;
      overflow-y: auto;
    }
    
    .corpses-list::-webkit-scrollbar {
      width: 4px;
    }
    
    .corpses-list::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .corpses-list::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
    }
    
    .corpse-item {
      background: rgba(255,255,255,0.04);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid transparent;
    }
    
    .corpse-item:last-child { 
      margin-bottom: 0; 
    }
    
    .corpse-item:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(108, 92, 231, 0.3);
      transform: translateX(2px);
    }
    
    .corpse-item .name { 
      font-size: 13px; 
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .corpse-item .meta { 
      font-size: 10px; 
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .corpse-item .meta span {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .corpse-item .tags {
      display: flex;
      gap: 4px;
      margin-top: 6px;
    }
    
    .tag {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(108, 92, 231, 0.2);
      color: #a29bfe;
    }
    
    .tag.zombie {
      background: rgba(214, 48, 49, 0.2);
      color: #ff7675;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }
    
    .empty-state .icon {
      font-size: 40px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .empty-state p {
      font-size: 12px;
    }
    
    /* åº•éƒ¨ */
    .footer {
      text-align: center;
      margin-top: 16px;
      color: var(--text-muted);
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .footer a {
      color: var(--accent-purple);
      text-decoration: none;
    }
    
    /* Toast é€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    .toast.success {
      border-color: var(--accent-green);
    }
    
    .toast.error {
      border-color: var(--accent-red);
    }
    
    /* è„‰å†²åŠ¨ç”» */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse {
      animation: pulse 2s ease-in-out infinite;
    }
    
    /* å“åº”å¼ */
    @media (max-width: 400px) {
      body {
        width: 100%;
        padding: 15px;
      }
      
      .header h1 {
        font-size: 20px;
      }
      
      .stats-grid {
        gap: 8px;
      }
      
      .stat-card {
        padding: 12px;
      }
      
      .stat-card .icon {
        font-size: 24px;
      }
      
      .stat-card .value {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸª¦ Code Corpses</h1>
    <p>ä»£ç å¢“åœ°ç›‘æ§ Â· å®ˆæŠ¤é¡¹ç›®å®‰å®</p>
    <span class="version-badge" id="version">v1.0</span>
  </div>
  
  <div class="stats-grid">
    <div class="stat-card">
      <span class="icon">ğŸ“Š</span>
      <div class="value" id="total-corpses">--</div>
      <div class="label">æ‰«æé¡¹ç›®</div>
    </div>
    <div class="stat-card zombie">
      <span class="icon">ğŸ§Ÿ</span>
      <div class="value" id="zombies-today">--</div>
      <div class="label">è¯ˆå°¸é¡¹ç›®</div>
    </div>
    <div class="stat-card scan">
      <span class="icon">ğŸ”„</span>
      <div class="value" id="last-scan">--</div>
      <div class="label">æœ€è¿‘æ‰«æ</div>
    </div>
    <div class="stat-card">
      <span class="icon">â­</span>
      <div class="value" id="total-stars">--</div>
      <div class="label">æ€»æ˜Ÿæ•°</div>
    </div>
  </div>
  
  <div class="actions">
    <button class="btn primary" id="scan-btn" onclick="scanCemetery()">
      <span class="btn-icon">ğŸ”</span>
      æ‰«æå¢“åœ°
    </button>
    <button class="btn secondary" onclick="openSettings()">
      <span class="btn-icon">âš™ï¸</span>
      è®¾ç½®
    </button>
    <button class="btn success" onclick="sendReport()">
      <span class="btn-icon">ğŸ“¤</span>
      å‘é€æŠ¥å‘Š
    </button>
  </div>
  
  <div class="scan-progress" id="scan-progress">
    <div class="label">
      <span>ğŸ”„ æ­£åœ¨æ‰«æ GitHub...</span>
      <span id="scan-percent">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
  </div>
  
  <div class="section-header">
    <div class="section-title">ğŸ“œ æœ€æ–°å¢“ç¢‘</div>
    <button class="refresh-btn" onclick="loadCorpses()">åˆ·æ–° âŸ³</button>
  </div>
  
  <div class="corpses-list" id="corpses-list">
    <div class="empty-state">
      <div class="icon">ğŸª¦</div>
      <p>æš‚æ— å¢“ç¢‘æ•°æ®<br>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰«æ</p>
    </div>
  </div>
  
  <div class="footer">
    <span>ğŸª¦ ä»£ç åƒå¤äº‹ï¼Œå¾—å¤±å¯¸å¿ƒçŸ¥</span>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">æ­£åœ¨å¤„ç†...</div>
  </div>

  <script>
    const invoke = window.__TAURI__.core.invoke;
    let isScanning = false;
    
    // æ˜¾ç¤º Toast
    function showToast(message, type = 'default') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // æ˜¾ç¤º/éšè—åŠ è½½
    function setLoading(show, text = 'æ­£åœ¨å¤„ç†...') {
      const loading = document.getElementById('loading');
      loading.querySelector('.loading-text').textContent = text;
      if (show) loading.classList.add('active');
      else loading.classList.remove('active');
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTimeAgo(dateStr) {
      if (!dateStr || dateStr === 'ä»æœªæ‰«æ') return 'æœªçŸ¥';
      
      try {
        const date = new Date(dateStr);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'åˆšåˆš';
        if (diff < 3600) return Math.floor(diff / 60) + ' åˆ†é’Ÿå‰';
        if (diff < 86400) return Math.floor(diff / 3600) + ' å°æ—¶å‰';
        return Math.floor(diff / 86400) + ' å¤©å‰';
      } catch (e) {
        return dateStr;
      }
    }
    
    // åŠ è½½ç»Ÿè®¡
    async function loadStats() {
      try {
        const stats = await invoke('get_stats');
        document.getElementById('total-corpses').textContent = stats.total || '0';
        document.getElementById('zombies-today').textContent = stats.zombies || '0';
        document.getElementById('last-scan').textContent = formatTimeAgo(stats.last_scan);
      } catch (e) {
        console.log('è·å–ç»Ÿè®¡å¤±è´¥:', e);
      }
    }
    
    // åŠ è½½ç‰ˆæœ¬
    async function loadVersion() {
      try {
        const version = await invoke('get_version');
        document.getElementById('version').textContent = 'v' + version;
      } catch (e) {
        // å¿½ç•¥
      }
    }
    
    // åŠ è½½å¢“ç¢‘åˆ—è¡¨
    async function loadCorpses() {
      try {
        const corpses = await invoke('get_recent_corpses', { limit: 10 });
        const list = document.getElementById('corpses-list');
        
        if (!corpses || corpses.length === 0) {
          list.innerHTML = `
            <div class="empty-state">
              <div class="icon">ğŸª¦</div>
              <p>æš‚æ— å¢“ç¢‘æ•°æ®<br>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ‰«æ</p>
            </div>
          `;
          return;
        }
        
        // è®¡ç®—æ€»æ˜Ÿæ•°
        let totalStars = corpses.reduce((sum, c) => sum + (c.stars || 0), 0);
        document.getElementById('total-stars').textContent = totalStars > 0 ? formatNumber(totalStars) : '--';
        
        list.innerHTML = corpses.map(c => `
          <div class="corpse-item" onclick="openRepo('${c.repo_url}')">
            <div class="name">
              ${c.language ? `<span style="color: ${getLangColor(c.language)}">â—</span>` : ''}
              ${c.name}
            </div>
            <div class="meta">
              <span>ğŸ’€ ${c.cause}</span>
              <span>â­ ${c.stars}</span>
              <span>ğŸ“… ${c.date}</span>
            </div>
            <div class="tags">
              <span class="tag zombie">ğŸ§Ÿ è¯ˆå°¸</span>
              ${c.language ? `<span class="tag">${c.language}</span>` : ''}
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.log('è·å–å¢“ç¢‘å¤±è´¥:', e);
      }
    }
    
    // æ ¼å¼åŒ–æ•°å­—
    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'k';
      }
      return num.toString();
    }
    
    // è¯­è¨€é¢œè‰²
    function getLangColor(lang) {
      const colors = {
        'Rust': '#dea584',
        'JavaScript': '#f1e05a',
        'TypeScript': '#2b7489',
        'Python': '#3572A5',
        'Go': '#00ADD8',
        'Java': '#b07219',
        'C++': '#f34b7d',
        'C': '#555555',
        'Vue': '#41b883',
        'HTML': '#e34c26',
        'CSS': '#563d7c',
      };
      return colors[lang] || '#888888';
    }
    
    // æ‰“å¼€ä»“åº“é“¾æ¥
    async function openRepo(url) {
      if (url && url !== 'https://github.com') {
        try {
          await invoke('open_url', { url });
        } catch (e) {
          await invoke('shell_open', { path: url });
        }
      }
    }
    
    // æ‰«æå¢“åœ°
    async function scanCemetery() {
      if (isScanning) return;
      
      isScanning = true;
      const btn = document.getElementById('scan-btn');
      const progress = document.getElementById('scan-progress');
      const progressFill = document.getElementById('progress-fill');
      const progressPercent = document.getElementById('scan-percent');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;"></span> æ‰«æä¸­...';
      progress.classList.add('active');
      
      try {
        const result = await invoke('trigger_scan');
        
        // æ¨¡æ‹Ÿè¿›åº¦
        for (let i = 0; i <= 100; i += 10) {
          progressFill.style.width = i + '%';
          progressPercent.textContent = i + '%';
          await new Promise(r => setTimeout(r, 100));
        }
        
        if (result.success) {
          showToast(`âœ… ${result.message}`, 'success');
          await loadStats();
          await loadCorpses();
        } else {
          showToast('âŒ æ‰«æå¤±è´¥: ' + result.message, 'error');
        }
      } catch (e) {
        console.log('æ‰«æå¤±è´¥:', e);
        showToast('âŒ æ‰«æå¤±è´¥: ' + (e.message || e), 'error');
      } finally {
        isScanning = false;
        btn.disabled = false;
        btn.innerHTML = '<span class="btn-icon">ğŸ”</span> æ‰«æå¢“åœ°';
        setTimeout(() => {
          progress.classList.remove('active');
          progressFill.style.width = '0%';
        }, 500);
      }
    }
    
    // æ‰“å¼€è®¾ç½®
    async function openSettings() {
      setLoading(true, 'åŠ è½½é…ç½®ä¸­...');
      try {
        const config = await invoke('load_config');
        
        const token = prompt(
          'GitHub Token è®¾ç½®\n\n' +
          'è¾“å…¥ä½ çš„ GitHub Personal Access Token (å¯é€‰):\n' +
          '- éœ€è¦ repo å’Œ read:org æƒé™\n' +
          '- æé«˜ API è®¿é—®é€Ÿç‡é™åˆ¶\n\n' +
          'å½“å‰ Token: ' + (config.github_token ? 'å·²è®¾ç½® âœ“' : 'æœªè®¾ç½®')
        );
        
        if (token !== null) {
          await invoke('update_github_token', { token: token.trim() });
          showToast('âœ… Token å·²æ›´æ–°', 'success');
        }
      } catch (e) {
        console.log('åŠ è½½é…ç½®å¤±è´¥:', e);
        showToast('âŒ åŠ è½½é…ç½®å¤±è´¥', 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // å‘é€æŠ¥å‘Š
    async function sendReport() {
      setLoading(true, 'æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...');
      try {
        const result = await invoke('send_report');
        showToast('ğŸ“¤ ' + result, 'success');
      } catch (e) {
        console.log('å‘é€å¤±è´¥:', e);
        showToast('âŒ å‘é€å¤±è´¥', 'error');
      } finally {
        setLoading(false);
      }
    }
    
    // åˆå§‹åŒ–
    async function init() {
      await loadVersion();
      await loadStats();
      await loadCorpses();
    }
    
    init();
    
    // å®šæ—¶åˆ·æ–° (æ¯5åˆ†é’Ÿ)
    setInterval(() => {
      if (!isScanning) {
        loadStats();
        loadCorpses();
      }
    }, 300000);
  </script>
</body>
</html>
